# 잘 뜨개질된 블록체인, 어떻게 변경할까?

새 트랜잭션 추가 및 변경하기

<br>

- `블록체인-데이터-구조`가 데이터 변화를 어떻게 감지하는지
- `변경-감지` 방식으로 데이터를 저장할 때의 `해시 참조`의 위력
- `블록체인-데이터-구조`에 새 블록을 올바르게 추가하는 방법

<br>

> **비유: 뜨개질**  
> `뜨개질`은 실을 떠서 직물이나 옷감으로 만드는 실공예이다. 손으로 직접 뜨다 보니 뜨개질 코의 크기가 들쑥날쑥 차이가 나기도 하는데, **중간의 어떤 코를 다시 뜨려면 그 앞의 코들을 전부 다 풀어야 한다.** 이 작업에 엄청난 시간과 노력이 소비된다.
>
> `블록체인-데이터-구조`의 맨 끝에 새 블록을 추가하는 거은 아주 쉽지만, **체인 중간에 있는 데이터를 수정하는 것은 엄청나게 힘이 든다.** 뜨개질의 비유를 기억하면, 블록체인-데이터-구조가 변경을 감지하는 방법과 데이터가 정확히 추가되고 수정되는 방법을 더 쉽게 이해하게 될 것이다.

<br>

## 1. 새로운 트랜잭션 추가하기

- 하나의 블록만 존재하는 그림
- 최초의 블록체인-데이터-구조는 단 2개의 트랜잭션만 가짐
- 트랜잭션 3과 4는 아직 블록체인-데이터-구조에 추가되지 않은 상태

![15_최초상황](https://github.com/lbo728/BlockChainStudy/assets/72309817/c74f61fb-5653-4d98-8592-4ef67966c298)
<최초 상황: 새로운 2개의 트랜잭션(트랜잭션 3과 4)이 기존의 블록체인-데이터-구조에 추가되어야함>

<br>

#### 새 트랜잭션 데이터를 추가하기 위한 3단계 수행

<br>

1. 새로 추가하려는 모든 트랜잭션 데이터를 담고 있는 새 머클트리 생성
   <br>

![15_2](https://github.com/lbo728/BlockChainStudy/assets/72309817/bc939667-fe76-4522-b1b2-8fe367284f97)

<단계 1>

<br>

2. `이전 블록 헤더`(블록 헤더1)를 가리키는 `해시 참조`(B1)와 `새로운 트랜잭션 데이터`(R34)를 담고 있는 머클 트리의 `루트`를 포함하는 `새 블록 헤더`(블록 헤더2)를 생성
   <br>
   ![15_3](https://github.com/lbo728/BlockChainStudy/assets/72309817/cb20d6bf-8e04-4f11-816e-f315b07fe1db)

   <단계 2>
   <br>

3. `새 블록을 가리키는 해시 참조`(B2)를 만들고 블록체인-데이터-구조의 `헤드`를 **B2**로 갱신

   - **체인의 헤드**: 가장 최근에 체인에 추가된 데이터를 가리키는 참조 ([14단계 참조](https://github.com/lbo728/BlockChainStudy/blob/main/%EB%B8%94%EB%A1%9D%EC%B2%B4%EC%9D%B8%20%EB%AC%B4%EC%97%87%EC%9D%B8%EA%B0%80%3F/03/14_%EB%B8%94%EB%A1%9D%EC%B2%B4%EC%9D%B8_%EB%8D%B0%EC%9D%B4%ED%84%B0_%EA%B5%AC%EC%A1%B0%EB%A5%BC_%EB%A7%8C%EB%93%A4%EC%96%B4%EB%B4%85%EC%8B%9C%EB%8B%A4.md#%EC%9D%B4-%EA%B7%B8%EB%A6%BC%EA%B3%BC-%EA%B0%99%EC%9D%80-%EB%B8%94%EB%A1%9D%EC%B2%B4%EC%9D%B8%EC%9D%84-%EC%9C%A0%EC%A7%80%ED%95%98%EA%B3%A0-%EC%9E%88%EB%8A%94-%EB%B6%84%EC%82%B0-p2p-%EC%8B%9C%EC%8A%A4%ED%85%9C%EC%9D%98-%EA%B2%BD%EC%9A%B0))
     <br>
     ![15_4](https://github.com/lbo728/BlockChainStudy/assets/72309817/74d1925e-784c-42f6-a7bd-9979bfbe1f1e)
     <단계 3>
     <br>

## 2. 변경 감지하기

블록체인-데이터-구조 내 어느 부분이든 변경되면 연쇄 반응을 일으켜 즉시 감지할 수 있음

### 1 | 트랜잭션 데이터의 내용을 변경하는 경우

트랜잭션 데이터의 세부 사항을 변경하면 **원래 데이터를 가리키는 해시 참조가 손상되고,** 결과적으로 전체 데이터 구조를 무효화 시킨다.

![15_5](https://github.com/lbo728/BlockChainStudy/assets/72309817/4736ea2a-cb6f-4eb6-9c53-799bfc27d2e1)

<br>

### 2 | 머클 트리의 참조를 변경하는 경우

머클 트리의 트랜잭션을 변경하고 그 해시 참조를 바꾸면, 전체 데이터 구조를 무효화 시킨다.

![15_6](https://github.com/lbo728/BlockChainStudy/assets/72309817/55300e21-76da-42c4-a79a-a653afb12095)

<br>

### 3 | 트랜잭션을 대체하는 경우

머클 트리의 트랜잭션과 그 해시 참조를 통째로 대체할 경우, **머클 트리 루트가 무효화** 되고 결과적으로 전체 데이터 구조를 무효화 시킨다.

![15_7](https://github.com/lbo728/BlockChainStudy/assets/72309817/2ae75808-efed-44d5-8ba6-35705e126c8e)

<br>

### 4 | 머클 트리 루트를 변경하는 경우

머클 트리를 변경하면 **자신을 가리키는 해시 참조를 가진 블록 헤더가 무효화되고,** 결과적으로 전체 데이터 구조를 무효화시킨다.

![15_8](https://github.com/lbo728/BlockChainStudy/assets/72309817/5c6b66ea-4266-4b0d-acf4-4f1eac4e2f56)

<br>

### 5 | 블록 헤더 참조를 변경하는 경우

블록 헤더 내의 해시 참조를 변경하면 **조작된 블록 헤더를 가리키는 해시 참조가 무효화되고,** 결과적으로 전체 데이터 구조를 무효화 시킨다.

![15_9](https://github.com/lbo728/BlockChainStudy/assets/72309817/dcd05de0-6991-4da4-a9aa-9c8545049f81)

<br>

→ 트랜잭션이 하나 변경되면 **부모 노드를 따라 연쇄 반응을 일으켜** 궁극적으로 블록 헤더값이 변경됨

- `변경된 블록 헤더값(R12)`은 `자신을 참조하는 블록의 헤더값(B1)`에 영향을 주어 자신 뒤에 있는 모든 값에 영향을 끼침

<br>

## 3. 제대로 된 데이터 변경 방법 알아보기

트랜잭션 2의 세부 항목을 변경하려면, 전체 해시 참조 연결고리인 `R2`, `R12`, `B1`, `B2`를 모두 갱신해야 함

- 즉, `변경된 데이터를 직접 가리키는 해시 참조`로부터 시작해서 `가장 최근 블록 헤더를 가리키는 해시 참조(헤드)`까지, 모든 해시 참조를 갱신해서 변경 내용을 반영해야 한다.

![15_10](https://github.com/lbo728/BlockChainStudy/assets/72309817/8fa0f979-6cfa-41fe-a429-f076a7762449)

<br>

## 4. 의도한 변경 vs 의도하지 않은 변경

블록체인-데이터-구조는 내용 변경은 **모-아니면-도의 접근 방식**을 추구

- 수정하다 말거나 혹은 일부만 수정하면, 전체 블록체인-데이터-구조의 일관성이 손상되어 그 즉시 변경이 감지됨
- 이는 `해시 참조`의 성질에서 비롯된 것으로, 블록체인-데이터-구조의 해시 참조는 의도된 변경이든 의도하지 않은 변경이든 구분하지 않고 동일하게 인식함
  - 블록체인은 동기나 일관성을 손상시킨 사람에게는 관심이 없고, 오직 모든 해시 참조의 `정확성`과 `일관성`만이 관심사이기 때문
    → 블록체인-데이터-구조를 매우 가치있게 만들어주는 요인
